"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.tsParserService = void 0;
const property_access_level_type_1 = require("src/enum/property-access-level-type");
const reference_type_1 = require("src/enum/reference-type");
const reference_1 = require("src/model/reference");
const ts_1 = __importDefault(require("src/module/ts"));
const ts_parser_import_1 = require("src/service/convert/ts/parser/ts-parser-import");
const logger_1 = require("src/util/logger");
const _self = {
    isExported: (modifiers) => {
        if (!modifiers)
            return false;
        return !!modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.ExportKeyword);
    },
    isAbstract: (modifiers) => {
        if (!modifiers)
            return false;
        return !!modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.AbstractKeyword);
    },
    accessLevel: (modifiers) => {
        if (!modifiers)
            return property_access_level_type_1.PropertyAccessLevelType.NO_MODIFIER;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.PublicKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PUBLIC;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.PrivateKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PRIVATE;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.ProtectedKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PROTECTED;
        return property_access_level_type_1.PropertyAccessLevelType.NO_MODIFIER;
    },
    checkIfThereAreAnyExports: (parsedSource) => {
        return !!parsedSource.statements.find((s) => _self._isViableExportableStatementKind(s.kind) && _self.isExported(s.modifiers));
    },
    _isViableExportableStatementKind: (kind) => {
        return [
            ts_1.default.SyntaxKind.TypeAliasDeclaration,
            ts_1.default.SyntaxKind.ClassDeclaration,
            ts_1.default.SyntaxKind.InterfaceDeclaration,
            ts_1.default.SyntaxKind.VariableDeclaration,
            ts_1.default.SyntaxKind.VariableStatement,
            ts_1.default.SyntaxKind.VariableDeclarationList,
            ts_1.default.SyntaxKind.EnumDeclaration,
        ].includes(kind);
    },
    findClassRelations: (params) => {
        const { statement, parsedSource, inProjectPath } = params;
        const extendImplements = (statement['heritageClauses'] ?? [])
            .map((heritage) => {
            const type = heritage.getText(parsedSource).split(' ')[0];
            return (heritage.types ?? []).map((t) => ({ type, name: t.expression.escapedText }));
        })
            .flat();
        if (extendImplements.length === 0)
            return [];
        const fileImports = parsedSource.statements
            .map((statement) => new ts_parser_import_1.TsParserImport({ statement, inProjectPath }).parse())
            .flat();
        return extendImplements
            .map((ei) => {
            const fileImport = fileImports.find((fi) => {
                return fi.name === ei.name;
            });
            if (!fileImport) {
                logger_1.logger.warn(`Import not found for ${JSON.stringify(ei)}`);
                return;
            }
            return new reference_1.Reference({
                name: ei.name,
                type: ei.type === 'implements' ? reference_type_1.ReferenceType.IMPLEMENTATION : reference_type_1.ReferenceType.INHERITANCE,
                inProjectPath: fileImport.inProjectPath,
            });
        })
            .filter(Boolean);
    },
    importsFromStatements: (params) => {
        const { parsedSource, inProjectPath } = params;
        return parsedSource.statements
            .map((statement) => _self.importsFromStatement({ statement, inProjectPath }))
            .filter(Boolean)
            .flat();
    },
    importsFromStatement: (params) => {
        const { statement, inProjectPath } = params;
        if (statement.kind != ts_1.default.SyntaxKind.ImportDeclaration)
            return [];
        return new ts_parser_import_1.TsParserImport({ statement, inProjectPath }).parse();
    },
    entityLinksFromStatements: (params) => {
        const { parsedSource, inProjectPath } = params;
        return parsedSource.statements
            .map((statement) => _self.entityLinksFromStatement({ statement, inProjectPath }))
            .filter(Boolean)
            .flat();
    },
    entityLinksFromStatement: (params) => {
        const { statement, inProjectPath } = params;
        if (!_self._isViableExportableStatementKind(statement.kind))
            return [];
        // TODO find a better solution to finding entity links
        if (statement['name'])
            return [{ name: statement['name'].escapedText, inProjectPath }];
        if (statement['declarationList'])
            return [{ name: statement['declarationList'].declarations[0].name.escapedText, inProjectPath }];
        return [];
    },
};
exports.tsParserService = _self;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHMtcGFyc2VyLXNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2VydmljZS9jb252ZXJ0L3RzL3RzLXBhcnNlci1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9GQUE2RTtBQUM3RSw0REFBdUQ7QUFDdkQsbURBQStDO0FBQy9DLHVEQUE4QjtBQUM5QixxRkFBMEc7QUFDMUcsNENBQXdDO0FBRXhDLE1BQU0sS0FBSyxHQUFHO0lBQ1osVUFBVSxFQUFFLENBQUMsU0FBNkIsRUFBVyxFQUFFO1FBQ3JELElBQUksQ0FBQyxTQUFTO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFDNUIsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFFLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBQ3hFLENBQUM7SUFDRCxVQUFVLEVBQUUsQ0FBQyxTQUE2QixFQUFXLEVBQUU7UUFDckQsSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLEtBQUssQ0FBQTtRQUM1QixPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLFlBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUE7SUFDMUUsQ0FBQztJQUNELFdBQVcsRUFBRSxDQUFDLFNBQTZCLEVBQTJCLEVBQUU7UUFDdEUsSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLG9EQUF1QixDQUFDLFdBQVcsQ0FBQTtRQUMxRCxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssWUFBRSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUM7WUFBRSxPQUFPLG9EQUF1QixDQUFDLE1BQU0sQ0FB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Q0FBQyxNQUE4RCxFQUErQixFQUFFO1FBQ3pILE1BQU0sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQzlDLE9BQU8sWUFBWSxDQUFDLFVBQVU7YUFDM0IsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQzthQUNoRixNQUFNLENBQUMsT0FBTyxDQUFDO2FBQ2YsSUFBSSxFQUFFLENBQUE7SUFDWCxDQUFDO0lBQ0Qsd0JBQXdCLEVBQUUsQ0FBQyxNQUEwRCxFQUErQixFQUFFO1FBQ3BILE1BQU0sRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztZQUFFLE9BQU8sRUFBRSxDQUFBO1FBRXRFLHNEQUFzRDtRQUN0RCxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUM7WUFBRSxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLElBQUksU0FBUyxDQUFDLGlCQUFpQixDQUFDO1lBQzlCLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO1FBRWpHLE9BQU8sRUFBRSxDQUFBO0lBQ1gsQ0FBQztDQUNGLENBQUE7QUFFWSxRQUFBLGVBQWUsR0FBRyxLQUFLLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZSB9IGZyb20gJ3NyYy9lbnVtL3Byb3BlcnR5LWFjY2Vzcy1sZXZlbC10eXBlJ1xuaW1wb3J0IHsgUmVmZXJlbmNlVHlwZSB9IGZyb20gJ3NyYy9lbnVtL3JlZmVyZW5jZS10eXBlJ1xuaW1wb3J0IHsgUmVmZXJlbmNlIH0gZnJvbSAnc3JjL21vZGVsL3JlZmVyZW5jZSdcbmltcG9ydCB0cyBmcm9tICdzcmMvbW9kdWxlL3RzJ1xuaW1wb3J0IHsgVHNQYXJzZXJJbXBvcnQsIFRzUGFyc2VySW1wb3J0UGFyc2VSZXN1bHQgfSBmcm9tICdzcmMvc2VydmljZS9jb252ZXJ0L3RzL3BhcnNlci90cy1wYXJzZXItaW1wb3J0J1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnc3JjL3V0aWwvbG9nZ2VyJ1xuXG5jb25zdCBfc2VsZiA9IHtcbiAgaXNFeHBvcnRlZDogKG1vZGlmaWVycz86IHRzLk1vZGlmaWVyc0FycmF5KTogYm9vbGVhbiA9PiB7XG4gICAgaWYgKCFtb2RpZmllcnMpIHJldHVybiBmYWxzZVxuICAgIHJldHVybiAhIW1vZGlmaWVycy5maW5kKChtKSA9PiBtLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuRXhwb3J0S2V5d29yZClcbiAgfSxcbiAgaXNBYnN0cmFjdDogKG1vZGlmaWVycz86IHRzLk1vZGlmaWVyc0FycmF5KTogYm9vbGVhbiA9PiB7XG4gICAgaWYgKCFtb2RpZmllcnMpIHJldHVybiBmYWxzZVxuICAgIHJldHVybiAhIW1vZGlmaWVycy5maW5kKChtKSA9PiBtLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuQWJzdHJhY3RLZXl3b3JkKVxuICB9LFxuICBhY2Nlc3NMZXZlbDogKG1vZGlmaWVycz86IHRzLk1vZGlmaWVyc0FycmF5KTogUHJvcGVydHlBY2Nlc3NMZXZlbFR5cGUgPT4ge1xuICAgIGlmICghbW9kaWZpZXJzKSByZXR1cm4gUHJvcGVydHlBY2Nlc3NMZXZlbFR5cGUuTk9fTU9ESUZJRVJcbiAgICBpZiAobW9kaWZpZXJzLmZpbmQoKG0pID0+IG0ua2luZCA9PT0gdHMuU3ludGF4S2luZC5QdWJsaWNLZXl3b3JkKSkgcmV0dXJuIFByb3BlcnR5QWNjZXNzTGV2ZWxUeXBlLlBVQkxJQ1xuICAgIGlmIChtb2RpZmllcnMuZmluZCgobSkgPT4gbS5raW5kID09PSB0cy5TeW50YXhLaW5kLlByaXZhdGVLZXl3b3JkKSkgcmV0dXJuIFByb3BlcnR5QWNjZXNzTGV2ZWxUeXBlLlBSSVZBVEVcbiAgICBpZiAobW9kaWZpZXJzLmZpbmQoKG0pID0+IG0ua2luZCA9PT0gdHMuU3ludGF4S2luZC5Qcm90ZWN0ZWRLZXl3b3JkKSkgcmV0dXJuIFByb3BlcnR5QWNjZXNzTGV2ZWxUeXBlLlBST1RFQ1RFRFxuICAgIHJldHVybiBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZS5OT19NT0RJRklFUlxuICB9LFxuICBjaGVja0lmVGhlcmVBcmVBbnlFeHBvcnRzOiAocGFyc2VkU291cmNlOiB0cy5Tb3VyY2VGaWxlKTogYm9vbGVhbiA9PiB7XG4gICAgcmV0dXJuICEhcGFyc2VkU291cmNlLnN0YXRlbWVudHMuZmluZCgocykgPT4gX3NlbGYuX2lzVmlhYmxlRXhwb3J0YWJsZVN0YXRlbWVudEtpbmQocy5raW5kKSAmJiBfc2VsZi5pc0V4cG9ydGVkKHMubW9kaWZpZXJzKSlcbiAgfSxcbiAgX2lzVmlhYmxlRXhwb3J0YWJsZVN0YXRlbWVudEtpbmQ6IChraW5kOiBudW1iZXIpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gW1xuICAgICAgdHMuU3ludGF4S2luZC5UeXBlQWxpYXNEZWNsYXJhdGlvbixcbiAgICAgIHRzLlN5bnRheEtpbmQuQ2xhc3NEZWNsYXJhdGlvbixcbiAgICAgIHRzLlN5bnRheEtpbmQuSW50ZXJmYWNlRGVjbGFyYXRpb24sXG4gICAgICB0cy5TeW50YXhLaW5kLlZhcmlhYmxlRGVjbGFyYXRpb24sXG4gICAgICB0cy5TeW50YXhLaW5kLlZhcmlhYmxlU3RhdGVtZW50LFxuICAgICAgdHMuU3ludGF4S2luZC5WYXJpYWJsZURlY2xhcmF0aW9uTGlzdCxcbiAgICAgIHRzLlN5bnRheEtpbmQuRW51bURlY2xhcmF0aW9uLFxuICAgIF0uaW5jbHVkZXMoa2luZClcbiAgfSxcbiAgZmluZENsYXNzUmVsYXRpb25zOiAocGFyYW1zOiB7IHN0YXRlbWVudDogdHMuU3RhdGVtZW50OyBwYXJzZWRTb3VyY2U6IHRzLlNvdXJjZUZpbGU7IGluUHJvamVjdFBhdGg6IHN0cmluZyB9KTogUmVmZXJlbmNlW10gPT4ge1xuICAgIGNvbnN0IHsgc3RhdGVtZW50LCBwYXJzZWRTb3VyY2UsIGluUHJvamVjdFBhdGggfSA9IHBhcmFtc1xuICAgIGNvbnN0IGV4dGVuZEltcGxlbWVudHMgPSAoc3RhdGVtZW50WydoZXJpdGFnZUNsYXVzZXMnXSA/PyBbXSlcbiAgICAgIC5tYXAoKGhlcml0YWdlKSA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBoZXJpdGFnZS5nZXRUZXh0KHBhcnNlZFNvdXJjZSkuc3BsaXQoJyAnKVswXVxuICAgICAgICByZXR1cm4gKGhlcml0YWdlLnR5cGVzID8/IFtdKS5tYXAoKHQpID0+ICh7IHR5cGUsIG5hbWU6IHQuZXhwcmVzc2lvbi5lc2NhcGVkVGV4dCB9KSlcbiAgICAgIH0pXG4gICAgICAuZmxhdCgpIGFzIHsgdHlwZTogJ2ltcGxlbWVudHMnIHwgJ2V4dGVuZHMnOyBuYW1lOiBzdHJpbmcgfVtdXG4gICAgaWYgKGV4dGVuZEltcGxlbWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gW11cblxuICAgIGNvbnN0IGZpbGVJbXBvcnRzID0gcGFyc2VkU291cmNlLnN0YXRlbWVudHNcbiAgICAgIC5tYXAoKHN0YXRlbWVudCkgPT4gbmV3IFRzUGFyc2VySW1wb3J0KHsgc3RhdGVtZW50LCBpblByb2plY3RQYXRoIH0pLnBhcnNlKCkpXG4gICAgICAuZmxhdCgpXG5cbiAgICByZXR1cm4gZXh0ZW5kSW1wbGVtZW50c1xuICAgICAgLm1hcCgoZWkpID0+IHtcbiAgICAgICAgY29uc3QgZmlsZUltcG9ydCA9IGZpbGVJbXBvcnRzLmZpbmQoKGZpKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGZpLm5hbWUgPT09IGVpLm5hbWVcbiAgICAgICAgfSlcbiAgICAgICAgaWYgKCFmaWxlSW1wb3J0KSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oYEltcG9ydCBub3QgZm91bmQgZm9yICR7SlNPTi5zdHJpbmdpZnkoZWkpfWApXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBSZWZlcmVuY2Uoe1xuICAgICAgICAgIG5hbWU6IGVpLm5hbWUsXG4gICAgICAgICAgdHlwZTogZWkudHlwZSA9PT0gJ2ltcGxlbWVudHMnID8gUmVmZXJlbmNlVHlwZS5JTVBMRU1FTlRBVElPTiA6IFJlZmVyZW5jZVR5cGUuSU5IRVJJVEFOQ0UsXG4gICAgICAgICAgaW5Qcm9qZWN0UGF0aDogZmlsZUltcG9ydC5pblByb2plY3RQYXRoLFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbikgYXMgUmVmZXJlbmNlW11cbiAgfSxcbiAgaW1wb3J0c0Zyb21TdGF0ZW1lbnRzOiAocGFyYW1zOiB7IHBhcnNlZFNvdXJjZTogdHMuU291cmNlRmlsZTsgaW5Qcm9qZWN0UGF0aDogc3RyaW5nIH0pOiBUc1BhcnNlckltcG9ydFBhcnNlUmVzdWx0W10gPT4ge1xuICAgIGNvbnN0IHsgcGFyc2VkU291cmNlLCBpblByb2plY3RQYXRoIH0gPSBwYXJhbXNcbiAgICByZXR1cm4gcGFyc2VkU291cmNlLnN0YXRlbWVudHNcbiAgICAgIC5tYXAoKHN0YXRlbWVudCkgPT4gX3NlbGYuaW1wb3J0c0Zyb21TdGF0ZW1lbnQoeyBzdGF0ZW1lbnQsIGluUHJvamVjdFBhdGggfSkpXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgICAuZmxhdCgpXG4gIH0sXG4gIGltcG9ydHNGcm9tU3RhdGVtZW50OiAocGFyYW1zOiB7IHN0YXRlbWVudDogdHMuU3RhdGVtZW50OyBpblByb2plY3RQYXRoOiBzdHJpbmcgfSk6IFRzUGFyc2VySW1wb3J0UGFyc2VSZXN1bHRbXSA9PiB7XG4gICAgY29uc3QgeyBzdGF0ZW1lbnQsIGluUHJvamVjdFBhdGggfSA9IHBhcmFtc1xuICAgIGlmIChzdGF0ZW1lbnQua2luZCAhPSB0cy5TeW50YXhLaW5kLkltcG9ydERlY2xhcmF0aW9uKSByZXR1cm4gW11cbiAgICByZXR1cm4gbmV3IFRzUGFyc2VySW1wb3J0KHsgc3RhdGVtZW50LCBpblByb2plY3RQYXRoIH0pLnBhcnNlKClcbiAgfSxcbiAgZW50aXR5TGlua3NGcm9tU3RhdGVtZW50czogKHBhcmFtczogeyBwYXJzZWRTb3VyY2U6IHRzLlNvdXJjZUZpbGU7IGluUHJvamVjdFBhdGg6IHN0cmluZyB9KTogVHNQYXJzZXJJbXBvcnRQYXJzZVJlc3VsdFtdID0+IHtcbiAgICBjb25zdCB7IHBhcnNlZFNvdXJjZSwgaW5Qcm9qZWN0UGF0aCB9ID0gcGFyYW1zXG4gICAgcmV0dXJuIHBhcnNlZFNvdXJjZS5zdGF0ZW1lbnRzXG4gICAgICAubWFwKChzdGF0ZW1lbnQpID0+IF9zZWxmLmVudGl0eUxpbmtzRnJvbVN0YXRlbWVudCh7IHN0YXRlbWVudCwgaW5Qcm9qZWN0UGF0aCB9KSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgIC5mbGF0KClcbiAgfSxcbiAgZW50aXR5TGlua3NGcm9tU3RhdGVtZW50OiAocGFyYW1zOiB7IHN0YXRlbWVudDogdHMuU3RhdGVtZW50OyBpblByb2plY3RQYXRoOiBzdHJpbmcgfSk6IFRzUGFyc2VySW1wb3J0UGFyc2VSZXN1bHRbXSA9PiB7XG4gICAgY29uc3QgeyBzdGF0ZW1lbnQsIGluUHJvamVjdFBhdGggfSA9IHBhcmFtc1xuICAgIGlmICghX3NlbGYuX2lzVmlhYmxlRXhwb3J0YWJsZVN0YXRlbWVudEtpbmQoc3RhdGVtZW50LmtpbmQpKSByZXR1cm4gW11cblxuICAgIC8vIFRPRE8gZmluZCBhIGJldHRlciBzb2x1dGlvbiB0byBmaW5kaW5nIGVudGl0eSBsaW5rc1xuICAgIGlmIChzdGF0ZW1lbnRbJ25hbWUnXSkgcmV0dXJuIFt7IG5hbWU6IHN0YXRlbWVudFsnbmFtZSddLmVzY2FwZWRUZXh0LCBpblByb2plY3RQYXRoIH1dXG4gICAgaWYgKHN0YXRlbWVudFsnZGVjbGFyYXRpb25MaXN0J10pXG4gICAgICByZXR1cm4gW3sgbmFtZTogc3RhdGVtZW50WydkZWNsYXJhdGlvbkxpc3QnXS5kZWNsYXJhdGlvbnNbMF0ubmFtZS5lc2NhcGVkVGV4dCwgaW5Qcm9qZWN0UGF0aCB9XVxuXG4gICAgcmV0dXJuIFtdXG4gIH0sXG59XG5cbmV4cG9ydCBjb25zdCB0c1BhcnNlclNlcnZpY2UgPSBfc2VsZlxuIl19