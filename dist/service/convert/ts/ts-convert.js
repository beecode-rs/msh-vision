"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TsConvert = void 0;
const ts_1 = __importDefault(require("src/module/ts"));
const ts_parser_file_1 = require("src/service/convert/ts/parser/ts-parser-file");
const ts_config_file_service_1 = require("src/service/convert/ts/ts-config-file-service");
const ts_entity_parser_1 = require("src/service/convert/ts/ts-entity-parser");
const ts_parser_service_1 = require("src/service/convert/ts/ts-parser-service");
const file_service_1 = require("src/service/file-service");
class TsConvert {
    constructor({ filePath, folderPath }) {
        this._filePath = filePath;
        this._folderPath = folderPath;
    }
    async convert() {
        await ts_config_file_service_1.tsConfigFileService.init();
        const fileName = file_service_1.fileService.fileNameFromPath(this._filePath, { withExtension: true });
        const parsedSource = await this._parseFile({ filePath: this._filePath, fileName });
        const hasExportsInFile = ts_parser_service_1.tsParserService.checkIfThereAreAnyExports(parsedSource);
        const inProjectPath = file_service_1.fileService.cleanupPath(this._filePath);
        const importParseResults = ts_parser_service_1.tsParserService.importsFromStatements({ parsedSource, inProjectPath });
        if (!hasExportsInFile)
            return new ts_parser_file_1.TsParserFile({ parsedSource, fileName, inProjectPath, importParseResults }).parse();
        const entityLinks = ts_parser_service_1.tsParserService.entityLinksFromStatements({ parsedSource, inProjectPath });
        const entityParser = new ts_entity_parser_1.TsEntityParser({
            parsedSource,
            fileName,
            inProjectPath,
            importParseResults: [...importParseResults, ...entityLinks],
        });
        return entityParser.parsedEntities();
    }
    /**
     * https://allenhwkim.medium.com/how-to-parse-typescript-from-source-643387971f4e
     *
     * https://ts-ast-viewer.com/#code/JYWwDg9gTgLgBAbzgYQuCA7Aph+BfOAMyjTgHIABAQwwHMBXAGyqgHoBjaLMgbgCgKqdNlwAKBHzhwAzlkZZ2MaAC5yIAJ5kANJLgws4ZvtVkAFnMYQ4ILADoyfPAEo+WAB6RYcds2nS4ALLqQpAi8BJ4QA
     */
    async _parseFile(params) {
        const { filePath, fileName } = params;
        const fileSource = await file_service_1.fileService.readFile(filePath);
        return ts_1.default.createSourceFile(fileName, fileSource, ts_1.default.ScriptTarget.ES2020); // TODO implement param for script target
    }
}
exports.TsConvert = TsConvert;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHMtY29udmVydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2aWNlL2NvbnZlcnQvdHMvdHMtY29udmVydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSx1REFBOEI7QUFFOUIsaUZBQTJFO0FBQzNFLDBGQUFtRjtBQUNuRiw4RUFBd0U7QUFDeEUsZ0ZBQTBFO0FBQzFFLDJEQUFzRDtBQUV0RCxNQUFhLFNBQVM7SUFJcEIsWUFBWSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQTRDO1FBQzVFLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFBO1FBQ3pCLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFBO0lBQy9CLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTztRQUNsQixNQUFNLDRDQUFtQixDQUFDLElBQUksRUFBRSxDQUFBO1FBQ2hDLE1BQU0sUUFBUSxHQUFHLDBCQUFXLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFFbEYsTUFBTSxnQkFBZ0IsR0FBRyxtQ0FBZSxDQUFDLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxDQUFBO1FBQ2hGLE1BQU0sYUFBYSxHQUFHLDBCQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUU3RCxNQUFNLGtCQUFrQixHQUFHLG1DQUFlLENBQUMscUJBQXFCLENBQUMsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQTtRQUNqRyxJQUFJLENBQUMsZ0JBQWdCO1lBQUUsT0FBTyxJQUFJLDZCQUFZLENBQUMsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxrQkFBa0IsRUFBRSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDckgsTUFBTSxXQUFXLEdBQUcsbUNBQWUsQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO1FBRTlGLE1BQU0sWUFBWSxHQUFHLElBQUksaUNBQWMsQ0FBQztZQUN0QyxZQUFZO1lBQ1osUUFBUTtZQUNSLGFBQWE7WUFDYixrQkFBa0IsRUFBRSxDQUFDLEdBQUcsa0JBQWtCLEVBQUUsR0FBRyxXQUFXLENBQUM7U0FDNUQsQ0FBQyxDQUFBO1FBQ0YsT0FBTyxZQUFZLENBQUMsY0FBYyxFQUFFLENBQUE7SUFDdEMsQ0FBQztJQUVEOzs7O09BSUc7SUFDTyxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQThDO1FBQ3ZFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQ3JDLE1BQU0sVUFBVSxHQUFHLE1BQU0sMEJBQVcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDdkQsT0FBTyxZQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxZQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUMseUNBQXlDO0lBQ3BILENBQUM7Q0FDRjtBQXhDRCw4QkF3Q0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHkgfSBmcm9tICdzcmMvbW9kZWwvZW50aXR5J1xuaW1wb3J0IHRzIGZyb20gJ3NyYy9tb2R1bGUvdHMnXG5pbXBvcnQgeyBDb252ZXJ0U3RyYXRlZ3kgfSBmcm9tICdzcmMvc2VydmljZS9jb252ZXJ0L2NvbnZlcnQtc3RyYXRlZ3knXG5pbXBvcnQgeyBUc1BhcnNlckZpbGUgfSBmcm9tICdzcmMvc2VydmljZS9jb252ZXJ0L3RzL3BhcnNlci90cy1wYXJzZXItZmlsZSdcbmltcG9ydCB7IHRzQ29uZmlnRmlsZVNlcnZpY2UgfSBmcm9tICdzcmMvc2VydmljZS9jb252ZXJ0L3RzL3RzLWNvbmZpZy1maWxlLXNlcnZpY2UnXG5pbXBvcnQgeyBUc0VudGl0eVBhcnNlciB9IGZyb20gJ3NyYy9zZXJ2aWNlL2NvbnZlcnQvdHMvdHMtZW50aXR5LXBhcnNlcidcbmltcG9ydCB7IHRzUGFyc2VyU2VydmljZSB9IGZyb20gJ3NyYy9zZXJ2aWNlL2NvbnZlcnQvdHMvdHMtcGFyc2VyLXNlcnZpY2UnXG5pbXBvcnQgeyBmaWxlU2VydmljZSB9IGZyb20gJ3NyYy9zZXJ2aWNlL2ZpbGUtc2VydmljZSdcblxuZXhwb3J0IGNsYXNzIFRzQ29udmVydCBpbXBsZW1lbnRzIENvbnZlcnRTdHJhdGVneSB7XG4gIHByb3RlY3RlZCByZWFkb25seSBfZmlsZVBhdGg6IHN0cmluZ1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgX2ZvbGRlclBhdGg6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKHsgZmlsZVBhdGgsIGZvbGRlclBhdGggfTogeyBmaWxlUGF0aDogc3RyaW5nOyBmb2xkZXJQYXRoOiBzdHJpbmcgfSkge1xuICAgIHRoaXMuX2ZpbGVQYXRoID0gZmlsZVBhdGhcbiAgICB0aGlzLl9mb2xkZXJQYXRoID0gZm9sZGVyUGF0aFxuICB9XG5cbiAgcHVibGljIGFzeW5jIGNvbnZlcnQoKTogUHJvbWlzZTxFbnRpdHlbXT4ge1xuICAgIGF3YWl0IHRzQ29uZmlnRmlsZVNlcnZpY2UuaW5pdCgpXG4gICAgY29uc3QgZmlsZU5hbWUgPSBmaWxlU2VydmljZS5maWxlTmFtZUZyb21QYXRoKHRoaXMuX2ZpbGVQYXRoLCB7IHdpdGhFeHRlbnNpb246IHRydWUgfSlcbiAgICBjb25zdCBwYXJzZWRTb3VyY2UgPSBhd2FpdCB0aGlzLl9wYXJzZUZpbGUoeyBmaWxlUGF0aDogdGhpcy5fZmlsZVBhdGgsIGZpbGVOYW1lIH0pXG5cbiAgICBjb25zdCBoYXNFeHBvcnRzSW5GaWxlID0gdHNQYXJzZXJTZXJ2aWNlLmNoZWNrSWZUaGVyZUFyZUFueUV4cG9ydHMocGFyc2VkU291cmNlKVxuICAgIGNvbnN0IGluUHJvamVjdFBhdGggPSBmaWxlU2VydmljZS5jbGVhbnVwUGF0aCh0aGlzLl9maWxlUGF0aClcblxuICAgIGNvbnN0IGltcG9ydFBhcnNlUmVzdWx0cyA9IHRzUGFyc2VyU2VydmljZS5pbXBvcnRzRnJvbVN0YXRlbWVudHMoeyBwYXJzZWRTb3VyY2UsIGluUHJvamVjdFBhdGggfSlcbiAgICBpZiAoIWhhc0V4cG9ydHNJbkZpbGUpIHJldHVybiBuZXcgVHNQYXJzZXJGaWxlKHsgcGFyc2VkU291cmNlLCBmaWxlTmFtZSwgaW5Qcm9qZWN0UGF0aCwgaW1wb3J0UGFyc2VSZXN1bHRzIH0pLnBhcnNlKClcbiAgICBjb25zdCBlbnRpdHlMaW5rcyA9IHRzUGFyc2VyU2VydmljZS5lbnRpdHlMaW5rc0Zyb21TdGF0ZW1lbnRzKHsgcGFyc2VkU291cmNlLCBpblByb2plY3RQYXRoIH0pXG5cbiAgICBjb25zdCBlbnRpdHlQYXJzZXIgPSBuZXcgVHNFbnRpdHlQYXJzZXIoe1xuICAgICAgcGFyc2VkU291cmNlLFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBpblByb2plY3RQYXRoLFxuICAgICAgaW1wb3J0UGFyc2VSZXN1bHRzOiBbLi4uaW1wb3J0UGFyc2VSZXN1bHRzLCAuLi5lbnRpdHlMaW5rc10sXG4gICAgfSlcbiAgICByZXR1cm4gZW50aXR5UGFyc2VyLnBhcnNlZEVudGl0aWVzKClcbiAgfVxuXG4gIC8qKlxuICAgKiBodHRwczovL2FsbGVuaHdraW0ubWVkaXVtLmNvbS9ob3ctdG8tcGFyc2UtdHlwZXNjcmlwdC1mcm9tLXNvdXJjZS02NDMzODc5NzFmNGVcbiAgICpcbiAgICogaHR0cHM6Ly90cy1hc3Qtdmlld2VyLmNvbS8jY29kZS9KWVd3RGc5Z1RnTGdCQWJ6Z1lRdUNBN0FwaCtCZk9BTXlqVGdISUFCQVF3d0hNQlhBR3lxZ0hvQmphTE1nYmdDZ0txZE5sd0FLQkh6aHdBemxrWloyTWFBQzV5SUFKNWtBTkpMZ3dzNFp2dFZrQUZuTVlRNElMQURveWZQQUVvK1dBQjZSWWNkczJuUzRBTExxUXBBaThCSjRRQVxuICAgKi9cbiAgcHJvdGVjdGVkIGFzeW5jIF9wYXJzZUZpbGUocGFyYW1zOiB7IGZpbGVQYXRoOiBzdHJpbmc7IGZpbGVOYW1lOiBzdHJpbmcgfSk6IFByb21pc2U8dHMuU291cmNlRmlsZT4ge1xuICAgIGNvbnN0IHsgZmlsZVBhdGgsIGZpbGVOYW1lIH0gPSBwYXJhbXNcbiAgICBjb25zdCBmaWxlU291cmNlID0gYXdhaXQgZmlsZVNlcnZpY2UucmVhZEZpbGUoZmlsZVBhdGgpXG4gICAgcmV0dXJuIHRzLmNyZWF0ZVNvdXJjZUZpbGUoZmlsZU5hbWUsIGZpbGVTb3VyY2UsIHRzLlNjcmlwdFRhcmdldC5FUzIwMjApIC8vIFRPRE8gaW1wbGVtZW50IHBhcmFtIGZvciBzY3JpcHQgdGFyZ2V0XG4gIH1cbn1cbiJdfQ==