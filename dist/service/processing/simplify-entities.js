"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SimplifyEntities = void 0;
const entity_types_1 = require("src/enum/entity-types");
const entity_1 = require("src/model/entity");
const entity_object_1 = require("src/model/entity-object");
const property_1 = require("src/model/property");
const reference_1 = require("src/model/reference");
class SimplifyEntities {
    _simplifyConfig;
    constructor(simplifyConfig) {
        this._simplifyConfig = simplifyConfig.reduce((acc, cur) => {
            acc = { ...acc, [cur[1]]: cur[0] };
            return acc;
        }, {});
    }
    process(entities) {
        if (Object.keys(this._simplifyConfig).length === 0)
            return entities;
        const entitiesUpdatedReferences = this._processReferences(entities);
        return this._simplifyEntities(entitiesUpdatedReferences);
    }
    _simplifyEntities(entities) {
        const { toSimplifyObj, other } = entities.reduce((acc, cur) => {
            const simKey = this._findSimplifiedEntityByPath(cur.InProjectPath);
            if (!simKey) {
                acc.other.push(cur);
                return acc;
            }
            acc.toSimplifyObj[simKey] = acc.toSimplifyObj[simKey] ?? [];
            acc.toSimplifyObj[simKey].push(cur);
            return acc;
        }, { toSimplifyObj: {}, other: [] });
        const simplifiedEntities = Object.entries(toSimplifyObj).map(([simplifyName, simplifiedEntities]) => {
            const references = simplifiedEntities
                .map((e) => {
                return e.References.map((r) => reference_1.Reference.cloneAndModify(r));
            })
                .flat();
            return new entity_1.Entity({
                type: entity_types_1.EntityTypes.OBJECT,
                name: simplifyName,
                inProjectPath: this._simplifyConfig[simplifyName],
                isExported: true,
                references: this._removeDuplicatedReferences(references),
                meta: new entity_object_1.EntityObject({
                    properties: simplifiedEntities.map((se) => {
                        return new property_1.Property({ name: `${se.Name} (${se.InProjectPath})`, returnType: '' });
                    }),
                }),
            });
        });
        return [...other, ...simplifiedEntities];
    }
    _processReferences(entities) {
        return entities.map((entity) => {
            const references = entity.References.map((ref) => {
                const simKey = this._findSimplifiedEntityByPath(ref.InProjectPath);
                if (!simKey)
                    return ref;
                return reference_1.Reference.cloneAndModify(ref, { name: simKey, inProjectPath: this._simplifyConfig[simKey] });
            });
            const noDuplicatedReferences = this._removeDuplicatedReferences(references);
            return entity_1.Entity.cloneAndModify(entity, { references: noDuplicatedReferences });
        });
    }
    _removeDuplicatedReferences(references) {
        return references.reduce((acc, cur) => {
            if (acc.find((e) => e.Name === cur.Name && e.InProjectPath === cur.InProjectPath))
                return acc;
            acc.push(cur);
            return acc;
        }, []);
    }
    _findSimplifiedEntityByPath(path) {
        const found = Object.entries(this._simplifyConfig).find(([_, value]) => path.startsWith(value));
        if (!found)
            return undefined;
        return found[0];
    }
}
exports.SimplifyEntities = SimplifyEntities;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltcGxpZnktZW50aXRpZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZS9wcm9jZXNzaW5nL3NpbXBsaWZ5LWVudGl0aWVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdEQUFtRDtBQUNuRCw2Q0FBeUM7QUFDekMsMkRBQXNEO0FBQ3RELGlEQUE2QztBQUM3QyxtREFBK0M7QUFHL0MsTUFBYSxnQkFBZ0I7SUFDUixlQUFlLENBQXlCO0lBRTNELFlBQVksY0FBa0M7UUFDNUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUEwQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNqRixHQUFHLEdBQUcsRUFBRSxHQUFHLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO1lBQ2xDLE9BQU8sR0FBRyxDQUFBO1FBQ1osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ1IsQ0FBQztJQUVNLE9BQU8sQ0FBQyxRQUFrQjtRQUMvQixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxRQUFRLENBQUE7UUFDbkUsTUFBTSx5QkFBeUIsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDbkUsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMseUJBQXlCLENBQUMsQ0FBQTtJQUMxRCxDQUFDO0lBRVMsaUJBQWlCLENBQUMsUUFBa0I7UUFDNUMsTUFBTSxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUUsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUM5QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNYLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUE7WUFDbEUsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDWCxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDbkIsT0FBTyxHQUFHLENBQUE7YUFDWDtZQUNELEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUE7WUFDM0QsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFFbkMsT0FBTyxHQUFHLENBQUE7UUFDWixDQUFDLEVBQ0QsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FDakMsQ0FBQTtRQUVELE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxrQkFBa0IsQ0FBQyxFQUFFLEVBQUU7WUFDbEcsTUFBTSxVQUFVLEdBQUcsa0JBQWtCO2lCQUNsQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDVCxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxxQkFBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQzdELENBQUMsQ0FBQztpQkFDRCxJQUFJLEVBQUUsQ0FBQTtZQUVULE9BQU8sSUFBSSxlQUFNLENBQUM7Z0JBQ2hCLElBQUksRUFBRSwwQkFBVyxDQUFDLE1BQU07Z0JBQ3hCLElBQUksRUFBRSxZQUFZO2dCQUNsQixhQUFhLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUM7Z0JBQ2pELFVBQVUsRUFBRSxJQUFJO2dCQUNoQixVQUFVLEVBQUUsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFVBQVUsQ0FBQztnQkFDeEQsSUFBSSxFQUFFLElBQUksNEJBQVksQ0FBQztvQkFDckIsVUFBVSxFQUFFLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFO3dCQUN4QyxPQUFPLElBQUksbUJBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLGFBQWEsR0FBRyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO29CQUNuRixDQUFDLENBQUM7aUJBQ0gsQ0FBQzthQUNILENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxDQUFDLEdBQUcsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQTtJQUMxQyxDQUFDO0lBRVMsa0JBQWtCLENBQUMsUUFBa0I7UUFDN0MsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDN0IsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDL0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLDJCQUEyQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQTtnQkFDbEUsSUFBSSxDQUFDLE1BQU07b0JBQUUsT0FBTyxHQUFHLENBQUE7Z0JBQ3ZCLE9BQU8scUJBQVMsQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDckcsQ0FBQyxDQUFDLENBQUE7WUFDRixNQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUMzRSxPQUFPLGVBQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEVBQUUsVUFBVSxFQUFFLHNCQUFzQixFQUFFLENBQUMsQ0FBQTtRQUM5RSxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFUywyQkFBMkIsQ0FBQyxVQUF1QjtRQUMzRCxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDcEMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLGFBQWEsS0FBSyxHQUFHLENBQUMsYUFBYSxDQUFDO2dCQUFFLE9BQU8sR0FBRyxDQUFBO1lBQzdGLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDYixPQUFPLEdBQUcsQ0FBQTtRQUNaLENBQUMsRUFBRSxFQUFpQixDQUFDLENBQUE7SUFDdkIsQ0FBQztJQUVTLDJCQUEyQixDQUFDLElBQVk7UUFDaEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUMvRixJQUFJLENBQUMsS0FBSztZQUFFLE9BQU8sU0FBUyxDQUFBO1FBQzVCLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pCLENBQUM7Q0FDRjtBQWpGRCw0Q0FpRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHlUeXBlcyB9IGZyb20gJ3NyYy9lbnVtL2VudGl0eS10eXBlcydcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJ3NyYy9tb2RlbC9lbnRpdHknXG5pbXBvcnQgeyBFbnRpdHlPYmplY3QgfSBmcm9tICdzcmMvbW9kZWwvZW50aXR5LW9iamVjdCdcbmltcG9ydCB7IFByb3BlcnR5IH0gZnJvbSAnc3JjL21vZGVsL3Byb3BlcnR5J1xuaW1wb3J0IHsgUmVmZXJlbmNlIH0gZnJvbSAnc3JjL21vZGVsL3JlZmVyZW5jZSdcbmltcG9ydCB7IFByb2Nlc3NpbmdTdHJhdGVneSB9IGZyb20gJ3NyYy9zZXJ2aWNlL3Byb2Nlc3NpbmcvcHJvY2Vzc2luZy1zZXJ2aWNlJ1xuXG5leHBvcnQgY2xhc3MgU2ltcGxpZnlFbnRpdGllcyBpbXBsZW1lbnRzIFByb2Nlc3NpbmdTdHJhdGVneSB7XG4gIHByb3RlY3RlZCByZWFkb25seSBfc2ltcGxpZnlDb25maWc6IHsgW2s6IHN0cmluZ106IHN0cmluZyB9XG5cbiAgY29uc3RydWN0b3Ioc2ltcGxpZnlDb25maWc6IFtzdHJpbmcsIHN0cmluZ11bXSkge1xuICAgIHRoaXMuX3NpbXBsaWZ5Q29uZmlnID0gc2ltcGxpZnlDb25maWcucmVkdWNlPHsgW2s6IHN0cmluZ106IHN0cmluZyB9PigoYWNjLCBjdXIpID0+IHtcbiAgICAgIGFjYyA9IHsgLi4uYWNjLCBbY3VyWzFdXTogY3VyWzBdIH1cbiAgICAgIHJldHVybiBhY2NcbiAgICB9LCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBwcm9jZXNzKGVudGl0aWVzOiBFbnRpdHlbXSk6IEVudGl0eVtdIHtcbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5fc2ltcGxpZnlDb25maWcpLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGVudGl0aWVzXG4gICAgY29uc3QgZW50aXRpZXNVcGRhdGVkUmVmZXJlbmNlcyA9IHRoaXMuX3Byb2Nlc3NSZWZlcmVuY2VzKGVudGl0aWVzKVxuICAgIHJldHVybiB0aGlzLl9zaW1wbGlmeUVudGl0aWVzKGVudGl0aWVzVXBkYXRlZFJlZmVyZW5jZXMpXG4gIH1cblxuICBwcm90ZWN0ZWQgX3NpbXBsaWZ5RW50aXRpZXMoZW50aXRpZXM6IEVudGl0eVtdKTogRW50aXR5W10ge1xuICAgIGNvbnN0IHsgdG9TaW1wbGlmeU9iaiwgb3RoZXIgfSA9IGVudGl0aWVzLnJlZHVjZTx7IHRvU2ltcGxpZnlPYmo6IHsgW2s6IHN0cmluZ106IEVudGl0eVtdIH07IG90aGVyOiBFbnRpdHlbXSB9PihcbiAgICAgIChhY2MsIGN1cikgPT4ge1xuICAgICAgICBjb25zdCBzaW1LZXkgPSB0aGlzLl9maW5kU2ltcGxpZmllZEVudGl0eUJ5UGF0aChjdXIuSW5Qcm9qZWN0UGF0aClcbiAgICAgICAgaWYgKCFzaW1LZXkpIHtcbiAgICAgICAgICBhY2Mub3RoZXIucHVzaChjdXIpXG4gICAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgICB9XG4gICAgICAgIGFjYy50b1NpbXBsaWZ5T2JqW3NpbUtleV0gPSBhY2MudG9TaW1wbGlmeU9ialtzaW1LZXldID8/IFtdXG4gICAgICAgIGFjYy50b1NpbXBsaWZ5T2JqW3NpbUtleV0ucHVzaChjdXIpXG5cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSxcbiAgICAgIHsgdG9TaW1wbGlmeU9iajoge30sIG90aGVyOiBbXSB9XG4gICAgKVxuXG4gICAgY29uc3Qgc2ltcGxpZmllZEVudGl0aWVzID0gT2JqZWN0LmVudHJpZXModG9TaW1wbGlmeU9iaikubWFwKChbc2ltcGxpZnlOYW1lLCBzaW1wbGlmaWVkRW50aXRpZXNdKSA9PiB7XG4gICAgICBjb25zdCByZWZlcmVuY2VzID0gc2ltcGxpZmllZEVudGl0aWVzXG4gICAgICAgIC5tYXAoKGUpID0+IHtcbiAgICAgICAgICByZXR1cm4gZS5SZWZlcmVuY2VzLm1hcCgocikgPT4gUmVmZXJlbmNlLmNsb25lQW5kTW9kaWZ5KHIpKVxuICAgICAgICB9KVxuICAgICAgICAuZmxhdCgpXG5cbiAgICAgIHJldHVybiBuZXcgRW50aXR5KHtcbiAgICAgICAgdHlwZTogRW50aXR5VHlwZXMuT0JKRUNULFxuICAgICAgICBuYW1lOiBzaW1wbGlmeU5hbWUsXG4gICAgICAgIGluUHJvamVjdFBhdGg6IHRoaXMuX3NpbXBsaWZ5Q29uZmlnW3NpbXBsaWZ5TmFtZV0sXG4gICAgICAgIGlzRXhwb3J0ZWQ6IHRydWUsXG4gICAgICAgIHJlZmVyZW5jZXM6IHRoaXMuX3JlbW92ZUR1cGxpY2F0ZWRSZWZlcmVuY2VzKHJlZmVyZW5jZXMpLFxuICAgICAgICBtZXRhOiBuZXcgRW50aXR5T2JqZWN0KHtcbiAgICAgICAgICBwcm9wZXJ0aWVzOiBzaW1wbGlmaWVkRW50aXRpZXMubWFwKChzZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eSh7IG5hbWU6IGAke3NlLk5hbWV9ICgke3NlLkluUHJvamVjdFBhdGh9KWAsIHJldHVyblR5cGU6ICcnIH0pXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgcmV0dXJuIFsuLi5vdGhlciwgLi4uc2ltcGxpZmllZEVudGl0aWVzXVxuICB9XG5cbiAgcHJvdGVjdGVkIF9wcm9jZXNzUmVmZXJlbmNlcyhlbnRpdGllczogRW50aXR5W10pOiBFbnRpdHlbXSB7XG4gICAgcmV0dXJuIGVudGl0aWVzLm1hcCgoZW50aXR5KSA9PiB7XG4gICAgICBjb25zdCByZWZlcmVuY2VzID0gZW50aXR5LlJlZmVyZW5jZXMubWFwKChyZWYpID0+IHtcbiAgICAgICAgY29uc3Qgc2ltS2V5ID0gdGhpcy5fZmluZFNpbXBsaWZpZWRFbnRpdHlCeVBhdGgocmVmLkluUHJvamVjdFBhdGgpXG4gICAgICAgIGlmICghc2ltS2V5KSByZXR1cm4gcmVmXG4gICAgICAgIHJldHVybiBSZWZlcmVuY2UuY2xvbmVBbmRNb2RpZnkocmVmLCB7IG5hbWU6IHNpbUtleSwgaW5Qcm9qZWN0UGF0aDogdGhpcy5fc2ltcGxpZnlDb25maWdbc2ltS2V5XSB9KVxuICAgICAgfSlcbiAgICAgIGNvbnN0IG5vRHVwbGljYXRlZFJlZmVyZW5jZXMgPSB0aGlzLl9yZW1vdmVEdXBsaWNhdGVkUmVmZXJlbmNlcyhyZWZlcmVuY2VzKVxuICAgICAgcmV0dXJuIEVudGl0eS5jbG9uZUFuZE1vZGlmeShlbnRpdHksIHsgcmVmZXJlbmNlczogbm9EdXBsaWNhdGVkUmVmZXJlbmNlcyB9KVxuICAgIH0pXG4gIH1cblxuICBwcm90ZWN0ZWQgX3JlbW92ZUR1cGxpY2F0ZWRSZWZlcmVuY2VzKHJlZmVyZW5jZXM6IFJlZmVyZW5jZVtdKTogUmVmZXJlbmNlW10ge1xuICAgIHJldHVybiByZWZlcmVuY2VzLnJlZHVjZSgoYWNjLCBjdXIpID0+IHtcbiAgICAgIGlmIChhY2MuZmluZCgoZSkgPT4gZS5OYW1lID09PSBjdXIuTmFtZSAmJiBlLkluUHJvamVjdFBhdGggPT09IGN1ci5JblByb2plY3RQYXRoKSkgcmV0dXJuIGFjY1xuICAgICAgYWNjLnB1c2goY3VyKVxuICAgICAgcmV0dXJuIGFjY1xuICAgIH0sIFtdIGFzIFJlZmVyZW5jZVtdKVxuICB9XG5cbiAgcHJvdGVjdGVkIF9maW5kU2ltcGxpZmllZEVudGl0eUJ5UGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGZvdW5kID0gT2JqZWN0LmVudHJpZXModGhpcy5fc2ltcGxpZnlDb25maWcpLmZpbmQoKFtfLCB2YWx1ZV0pID0+IHBhdGguc3RhcnRzV2l0aCh2YWx1ZSkpXG4gICAgaWYgKCFmb3VuZCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIHJldHVybiBmb3VuZFswXVxuICB9XG59XG4iXX0=