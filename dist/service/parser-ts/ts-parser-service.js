"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.tsParserService = void 0;
const property_access_level_type_1 = require("src/enum/property-access-level-type");
const reference_type_1 = require("src/enum/reference-type");
const reference_1 = require("src/model/reference");
const ts_1 = __importDefault(require("src/module/ts"));
const ts_parser_import_1 = require("src/service/parser-ts/parser/ts-parser-import");
const logger_1 = require("src/util/logger");
const _self = {
    isExported: (modifiers) => {
        if (!modifiers)
            return false;
        return !!modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.ExportKeyword);
    },
    isAbstract: (modifiers) => {
        if (!modifiers)
            return false;
        return !!modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.AbstractKeyword);
    },
    accessLevel: (modifiers) => {
        if (!modifiers)
            return property_access_level_type_1.PropertyAccessLevelType.NO_MODIFIER;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.PublicKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PUBLIC;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.PrivateKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PRIVATE;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.ProtectedKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PROTECTED;
        return property_access_level_type_1.PropertyAccessLevelType.NO_MODIFIER;
    },
    checkIfThereAreAnyExports: (parsedSource) => {
        return !!parsedSource.statements.find((s) => _self._isViableExportableStatementKind(s.kind) && _self.isExported(s.modifiers));
    },
    _isViableExportableStatementKind: (kind) => {
        return [
            ts_1.default.SyntaxKind.TypeAliasDeclaration,
            ts_1.default.SyntaxKind.ClassDeclaration,
            ts_1.default.SyntaxKind.InterfaceDeclaration,
            ts_1.default.SyntaxKind.VariableDeclaration,
            ts_1.default.SyntaxKind.VariableStatement,
            ts_1.default.SyntaxKind.VariableDeclarationList,
            ts_1.default.SyntaxKind.EnumDeclaration,
        ].includes(kind);
    },
    findClassRelations: (params) => {
        const { statement, parsedSource, inProjectPath } = params;
        const extendImplements = (statement['heritageClauses'] ?? [])
            .map((heritage) => {
            const type = heritage.getText(parsedSource).split(' ')[0];
            return (heritage.types ?? []).map((t) => ({ type, name: t.expression.escapedText }));
        })
            .flat();
        if (extendImplements.length === 0)
            return [];
        const fileImports = parsedSource.statements
            .map((statement) => new ts_parser_import_1.TsParserImport({ statement, inProjectPath }).parse())
            .flat();
        return extendImplements
            .map((ei) => {
            const fileImport = fileImports.find((fi) => {
                return fi.name === ei.name;
            });
            if (!fileImport) {
                logger_1.logger.warn(`Import not found for ${JSON.stringify(ei)}`);
                return;
            }
            return new reference_1.Reference({
                name: ei.name,
                type: ei.type === 'implements' ? reference_type_1.ReferenceType.IMPLEMENTATION : reference_type_1.ReferenceType.INHERITANCE,
                inProjectPath: fileImport.inProjectPath,
            });
        })
            .filter(Boolean);
    },
    importsFromStatements: (params) => {
        const { parsedSource, inProjectPath } = params;
        return parsedSource.statements
            .map((statement) => _self.importsFromStatement({ statement, inProjectPath }))
            .filter(Boolean)
            .flat();
    },
    importsFromStatement: (params) => {
        const { statement, inProjectPath } = params;
        if (statement.kind != ts_1.default.SyntaxKind.ImportDeclaration)
            return [];
        return new ts_parser_import_1.TsParserImport({ statement, inProjectPath }).parse();
    },
    entityLinksFromStatements: (params) => {
        const { parsedSource, inProjectPath } = params;
        return parsedSource.statements
            .map((statement) => _self.entityLinksFromStatement({ statement, inProjectPath }))
            .filter(Boolean)
            .flat();
    },
    entityLinksFromStatement: (params) => {
        const { statement, inProjectPath } = params;
        if (!_self._isViableExportableStatementKind(statement.kind))
            return [];
        // TODO find a better solution to finding entity links
        if (statement['name'])
            return [{ name: statement['name'].escapedText, inProjectPath }];
        if (statement['declarationList'] && statement['declarationList'].declarations[0].name.escapedText)
            return [{ name: statement['declarationList'].declarations[0].name.escapedText, inProjectPath }];
        return [];
    },
};
exports.tsParserService = _self;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHMtcGFyc2VyLXNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZS9wYXJzZXItdHMvdHMtcGFyc2VyLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsb0ZBQTZFO0FBQzdFLDREQUF1RDtBQUN2RCxtREFBK0M7QUFDL0MsdURBQThCO0FBQzlCLG9GQUF5RztBQUN6Ryw0Q0FBd0M7QUFFeEMsTUFBTSxLQUFLLEdBQUc7SUFDWixVQUFVLEVBQUUsQ0FBQyxTQUE2QixFQUFXLEVBQUU7UUFDckQsSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLEtBQUssQ0FBQTtRQUM1QixPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLFlBQUUsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUE7SUFDeEUsQ0FBQztJQUNELFVBQVUsRUFBRSxDQUFDLFNBQTZCLEVBQVcsRUFBRTtRQUNyRCxJQUFJLENBQUMsU0FBUztZQUFFLE9BQU8sS0FBSyxDQUFBO1FBQzVCLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssWUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUMxRSxDQUFDO0lBQ0QsV0FBVyxFQUFFLENBQUMsU0FBNkIsRUFBMkIsRUFBRTtRQUN0RSxJQUFJLENBQUMsU0FBUztZQUFFLE9BQU8sb0RBQXVCLENBQUMsV0FBVyxDQUFBO1FBQzFELElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFFLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztZQUFFLE9BQU8sb0RBQXVCLENBQUMsTUFBTSxDQUFBO1FB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ZnJvbSAnc3JjL2VudW0vcHJvcGVydHktYWNjZXNzLWxldmVsLXR5cGUnXG5pbXBvcnQgeyBSZWZlcmVuY2VUeXBlIH0gZnJvbSAnc3JjL2VudW0vcmVmZXJlbmNlLXR5cGUnXG5pbXBvcnQgeyBSZWZlcmVuY2UgfSBmcm9tICdzcmMvbW9kZWwvcmVmZXJlbmNlJ1xuaW1wb3J0IHRzIGZyb20gJ3NyYy9tb2R1bGUvdHMnXG5pbXBvcnQgeyBUc1BhcnNlckltcG9ydCwgVHNQYXJzZXJJbXBvcnRQYXJzZVJlc3VsdCB9IGZyb20gJ3NyYy9zZXJ2aWNlL3BhcnNlci10cy9wYXJzZXIvdHMtcGFyc2VyLWltcG9ydCdcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ3NyYy91dGlsL2xvZ2dlcidcblxuY29uc3QgX3NlbGYgPSB7XG4gIGlzRXhwb3J0ZWQ6IChtb2RpZmllcnM/OiB0cy5Nb2RpZmllcnNBcnJheSk6IGJvb2xlYW4gPT4ge1xuICAgIGlmICghbW9kaWZpZXJzKSByZXR1cm4gZmFsc2VcbiAgICByZXR1cm4gISFtb2RpZmllcnMuZmluZCgobSkgPT4gbS5raW5kID09PSB0cy5TeW50YXhLaW5kLkV4cG9ydEtleXdvcmQpXG4gIH0sXG4gIGlzQWJzdHJhY3Q6IChtb2RpZmllcnM/OiB0cy5Nb2RpZmllcnNBcnJheSk6IGJvb2xlYW4gPT4ge1xuICAgIGlmICghbW9kaWZpZXJzKSByZXR1cm4gZmFsc2VcbiAgICByZXR1cm4gISFtb2RpZmllcnMuZmluZCgobSkgPT4gbS5raW5kID09PSB0cy5TeW50YXhLaW5kLkFic3RyYWN0S2V5d29yZClcbiAgfSxcbiAgYWNjZXNzTGV2ZWw6IChtb2RpZmllcnM/OiB0cy5Nb2RpZmllcnNBcnJheSk6IFByb3BlcnR5QWNjZXNzTGV2ZWxUeXBlID0+IHtcbiAgICBpZiAoIW1vZGlmaWVycykgcmV0dXJuIFByb3BlcnR5QWNjZXNzTGV2ZWxUeXBlLk5PX01PRElGSUVSXG4gICAgaWYgKG1vZGlmaWVycy5maW5kKChtKSA9PiBtLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuUHVibGljS2V5d29yZCkpIHJldHVybiBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZS5QVUJMSUNcbiAgICBpZiAobW9kaWZpZXJzLmZpbmQoKG0pID0+IG0ua2luZCA9PT0gdHMuU3ludGF4S2luZC5Qcml2YXRlS2V5d29yZCkpIHJldHVybiBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZS5QUklWQVRFXG4gICAgaWYgKG1vZGlmaWVycy5maW5kKChtKSA9PiBtLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuUHJvdGVjdGVkS2V5d29yZCkpIHJldHVybiBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZS5QUk9URUNURURcbiAgICByZXR1cm4gUHJvcGVydHlBY2Nlc3NMZXZlbFR5cGUuTk9fTU9ESUZJRVJcbiAgfSxcbiAgY2hlY2tJZlRoZXJlQXJlQW55RXhwb3J0czogKHBhcnNlZFNvdXJjZTogdHMuU291cmNlRmlsZSk6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiAhIXBhcnNlZFNvdXJjZS5zdGF0ZW1lbnRzLmZpbmQoKHMpID0+IF9zZWxmLl9pc1ZpYWJsZUV4cG9ydGFibGVTdGF0ZW1lbnRLaW5kKHMua2luZCkgJiYgX3NlbGYuaXNFeHBvcnRlZChzLm1vZGlmaWVycykpXG4gIH0sXG4gIF9pc1ZpYWJsZUV4cG9ydGFibGVTdGF0ZW1lbnRLaW5kOiAoa2luZDogbnVtYmVyKTogYm9vbGVhbiA9PiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHRzLlN5bnRheEtpbmQuVHlwZUFsaWFzRGVjbGFyYXRpb24sXG4gICAgICB0cy5TeW50YXhLaW5kLkNsYXNzRGVjbGFyYXRpb24sXG4gICAgICB0cy5TeW50YXhLaW5kLkludGVyZmFjZURlY2xhcmF0aW9uLFxuICAgICAgdHMuU3ludGF4S2luZC5WYXJpYWJsZURlY2xhcmF0aW9uLFxuICAgICAgdHMuU3ludGF4S2luZC5WYXJpYWJsZVN0YXRlbWVudCxcbiAgICAgIHRzLlN5bnRheEtpbmQuVmFyaWFibGVEZWNsYXJhdGlvbkxpc3QsXG4gICAgICB0cy5TeW50YXhLaW5kLkVudW1EZWNsYXJhdGlvbixcbiAgICBdLmluY2x1ZGVzKGtpbmQpXG4gIH0sXG4gIGZpbmRDbGFzc1JlbGF0aW9uczogKHBhcmFtczogeyBzdGF0ZW1lbnQ6IHRzLlN0YXRlbWVudDsgcGFyc2VkU291cmNlOiB0cy5Tb3VyY2VGaWxlOyBpblByb2plY3RQYXRoOiBzdHJpbmcgfSk6IFJlZmVyZW5jZVtdID0+IHtcbiAgICBjb25zdCB7IHN0YXRlbWVudCwgcGFyc2VkU291cmNlLCBpblByb2plY3RQYXRoIH0gPSBwYXJhbXNcbiAgICBjb25zdCBleHRlbmRJbXBsZW1lbnRzID0gKHN0YXRlbWVudFsnaGVyaXRhZ2VDbGF1c2VzJ10gPz8gW10pXG4gICAgICAubWFwKChoZXJpdGFnZSkgPT4ge1xuICAgICAgICBjb25zdCB0eXBlID0gaGVyaXRhZ2UuZ2V0VGV4dChwYXJzZWRTb3VyY2UpLnNwbGl0KCcgJylbMF1cbiAgICAgICAgcmV0dXJuIChoZXJpdGFnZS50eXBlcyA/PyBbXSkubWFwKCh0KSA9PiAoeyB0eXBlLCBuYW1lOiB0LmV4cHJlc3Npb24uZXNjYXBlZFRleHQgfSkpXG4gICAgICB9KVxuICAgICAgLmZsYXQoKSBhcyB7IHR5cGU6ICdpbXBsZW1lbnRzJyB8ICdleHRlbmRzJzsgbmFtZTogc3RyaW5nIH1bXVxuICAgIGlmIChleHRlbmRJbXBsZW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdXG5cbiAgICBjb25zdCBmaWxlSW1wb3J0cyA9IHBhcnNlZFNvdXJjZS5zdGF0ZW1lbnRzXG4gICAgICAubWFwKChzdGF0ZW1lbnQpID0+IG5ldyBUc1BhcnNlckltcG9ydCh7IHN0YXRlbWVudCwgaW5Qcm9qZWN0UGF0aCB9KS5wYXJzZSgpKVxuICAgICAgLmZsYXQoKVxuXG4gICAgcmV0dXJuIGV4dGVuZEltcGxlbWVudHNcbiAgICAgIC5tYXAoKGVpKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVJbXBvcnQgPSBmaWxlSW1wb3J0cy5maW5kKChmaSkgPT4ge1xuICAgICAgICAgIHJldHVybiBmaS5uYW1lID09PSBlaS5uYW1lXG4gICAgICAgIH0pXG4gICAgICAgIGlmICghZmlsZUltcG9ydCkge1xuICAgICAgICAgIGxvZ2dlci53YXJuKGBJbXBvcnQgbm90IGZvdW5kIGZvciAke0pTT04uc3RyaW5naWZ5KGVpKX1gKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgUmVmZXJlbmNlKHtcbiAgICAgICAgICBuYW1lOiBlaS5uYW1lLFxuICAgICAgICAgIHR5cGU6IGVpLnR5cGUgPT09ICdpbXBsZW1lbnRzJyA/IFJlZmVyZW5jZVR5cGUuSU1QTEVNRU5UQVRJT04gOiBSZWZlcmVuY2VUeXBlLklOSEVSSVRBTkNFLFxuICAgICAgICAgIGluUHJvamVjdFBhdGg6IGZpbGVJbXBvcnQuaW5Qcm9qZWN0UGF0aCxcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pIGFzIFJlZmVyZW5jZVtdXG4gIH0sXG4gIGltcG9ydHNGcm9tU3RhdGVtZW50czogKHBhcmFtczogeyBwYXJzZWRTb3VyY2U6IHRzLlNvdXJjZUZpbGU7IGluUHJvamVjdFBhdGg6IHN0cmluZyB9KTogVHNQYXJzZXJJbXBvcnRQYXJzZVJlc3VsdFtdID0+IHtcbiAgICBjb25zdCB7IHBhcnNlZFNvdXJjZSwgaW5Qcm9qZWN0UGF0aCB9ID0gcGFyYW1zXG4gICAgcmV0dXJuIHBhcnNlZFNvdXJjZS5zdGF0ZW1lbnRzXG4gICAgICAubWFwKChzdGF0ZW1lbnQpID0+IF9zZWxmLmltcG9ydHNGcm9tU3RhdGVtZW50KHsgc3RhdGVtZW50LCBpblByb2plY3RQYXRoIH0pKVxuICAgICAgLmZpbHRlcihCb29sZWFuKVxuICAgICAgLmZsYXQoKVxuICB9LFxuICBpbXBvcnRzRnJvbVN0YXRlbWVudDogKHBhcmFtczogeyBzdGF0ZW1lbnQ6IHRzLlN0YXRlbWVudDsgaW5Qcm9qZWN0UGF0aDogc3RyaW5nIH0pOiBUc1BhcnNlckltcG9ydFBhcnNlUmVzdWx0W10gPT4ge1xuICAgIGNvbnN0IHsgc3RhdGVtZW50LCBpblByb2plY3RQYXRoIH0gPSBwYXJhbXNcbiAgICBpZiAoc3RhdGVtZW50LmtpbmQgIT0gdHMuU3ludGF4S2luZC5JbXBvcnREZWNsYXJhdGlvbikgcmV0dXJuIFtdXG4gICAgcmV0dXJuIG5ldyBUc1BhcnNlckltcG9ydCh7IHN0YXRlbWVudCwgaW5Qcm9qZWN0UGF0aCB9KS5wYXJzZSgpXG4gIH0sXG4gIGVudGl0eUxpbmtzRnJvbVN0YXRlbWVudHM6IChwYXJhbXM6IHsgcGFyc2VkU291cmNlOiB0cy5Tb3VyY2VGaWxlOyBpblByb2plY3RQYXRoOiBzdHJpbmcgfSk6IFRzUGFyc2VySW1wb3J0UGFyc2VSZXN1bHRbXSA9PiB7XG4gICAgY29uc3QgeyBwYXJzZWRTb3VyY2UsIGluUHJvamVjdFBhdGggfSA9IHBhcmFtc1xuICAgIHJldHVybiBwYXJzZWRTb3VyY2Uuc3RhdGVtZW50c1xuICAgICAgLm1hcCgoc3RhdGVtZW50KSA9PiBfc2VsZi5lbnRpdHlMaW5rc0Zyb21TdGF0ZW1lbnQoeyBzdGF0ZW1lbnQsIGluUHJvamVjdFBhdGggfSkpXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgICAuZmxhdCgpXG4gIH0sXG4gIGVudGl0eUxpbmtzRnJvbVN0YXRlbWVudDogKHBhcmFtczogeyBzdGF0ZW1lbnQ6IHRzLlN0YXRlbWVudDsgaW5Qcm9qZWN0UGF0aDogc3RyaW5nIH0pOiBUc1BhcnNlckltcG9ydFBhcnNlUmVzdWx0W10gPT4ge1xuICAgIGNvbnN0IHsgc3RhdGVtZW50LCBpblByb2plY3RQYXRoIH0gPSBwYXJhbXNcbiAgICBpZiAoIV9zZWxmLl9pc1ZpYWJsZUV4cG9ydGFibGVTdGF0ZW1lbnRLaW5kKHN0YXRlbWVudC5raW5kKSkgcmV0dXJuIFtdXG5cbiAgICAvLyBUT0RPIGZpbmQgYSBiZXR0ZXIgc29sdXRpb24gdG8gZmluZGluZyBlbnRpdHkgbGlua3NcbiAgICBpZiAoc3RhdGVtZW50WyduYW1lJ10pIHJldHVybiBbeyBuYW1lOiBzdGF0ZW1lbnRbJ25hbWUnXS5lc2NhcGVkVGV4dCwgaW5Qcm9qZWN0UGF0aCB9XVxuICAgIGlmIChzdGF0ZW1lbnRbJ2RlY2xhcmF0aW9uTGlzdCddICYmIHN0YXRlbWVudFsnZGVjbGFyYXRpb25MaXN0J10uZGVjbGFyYXRpb25zWzBdLm5hbWUuZXNjYXBlZFRleHQpXG4gICAgICByZXR1cm4gW3sgbmFtZTogc3RhdGVtZW50WydkZWNsYXJhdGlvbkxpc3QnXS5kZWNsYXJhdGlvbnNbMF0ubmFtZS5lc2NhcGVkVGV4dCwgaW5Qcm9qZWN0UGF0aCB9XVxuXG4gICAgcmV0dXJuIFtdXG4gIH0sXG59XG5cbmV4cG9ydCBjb25zdCB0c1BhcnNlclNlcnZpY2UgPSBfc2VsZlxuIl19