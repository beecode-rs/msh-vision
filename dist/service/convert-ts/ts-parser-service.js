"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.tsParserService = void 0;
const property_access_level_type_1 = require("src/enum/property-access-level-type");
const reference_type_1 = require("src/enum/reference-type");
const ts_1 = __importDefault(require("src/module/ts"));
const ts_parser_import_1 = require("src/service/convert-ts/parser/ts-parser-import");
const reference_1 = require("src/service/model/reference");
const logger_1 = require("src/util/logger");
const _self = {
    isExported: (modifiers) => {
        if (!modifiers)
            return false;
        return !!modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.ExportKeyword);
    },
    isAbstract: (modifiers) => {
        if (!modifiers)
            return false;
        return !!modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.AbstractKeyword);
    },
    accessLevel: (modifiers) => {
        if (!modifiers)
            return property_access_level_type_1.PropertyAccessLevelType.NO_MODIFIER;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.PublicKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PUBLIC;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.PrivateKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PRIVATE;
        if (modifiers.find((m) => m.kind === ts_1.default.SyntaxKind.ProtectedKeyword))
            return property_access_level_type_1.PropertyAccessLevelType.PROTECTED;
        return property_access_level_type_1.PropertyAccessLevelType.NO_MODIFIER;
    },
    checkIfThereAreAnyExports: (parsedSource) => {
        return !!parsedSource.statements.find((s) => _self._isViableExportableStatementKind(s.kind) && _self.isExported(s.modifiers));
    },
    _isViableExportableStatementKind: (kind) => {
        return [
            ts_1.default.SyntaxKind.TypeAliasDeclaration,
            ts_1.default.SyntaxKind.ClassDeclaration,
            ts_1.default.SyntaxKind.InterfaceDeclaration,
            ts_1.default.SyntaxKind.VariableDeclaration,
            ts_1.default.SyntaxKind.VariableStatement,
            ts_1.default.SyntaxKind.VariableDeclarationList,
            ts_1.default.SyntaxKind.EnumDeclaration,
        ].includes(kind);
    },
    findClassRelations: (params) => {
        const { statement, parsedSource, inProjectPath } = params;
        const extendImplements = (statement['heritageClauses'] ?? [])
            .map((heritage) => {
            const type = heritage.getText(parsedSource).split(' ')[0];
            return (heritage.types ?? []).map((t) => ({ type, name: t.expression.escapedText }));
        })
            .flat();
        if (extendImplements.length === 0)
            return [];
        const fileImports = parsedSource.statements
            .map((statement) => new ts_parser_import_1.TsParserImport({ statement, inProjectPath }).parse())
            .flat();
        return extendImplements
            .map((ei) => {
            const fileImport = fileImports.find((fi) => {
                return fi.name === ei.name;
            });
            if (!fileImport) {
                logger_1.logger.warn(`Import not found for ${JSON.stringify(ei)}`);
                return;
            }
            return new reference_1.Reference({
                name: ei.name,
                type: ei.type === 'implements' ? reference_type_1.ReferenceType.IMPLEMENTATION : reference_type_1.ReferenceType.INHERITANCE,
                inProjectPath: fileImport.inProjectPath,
            });
        })
            .filter(Boolean);
    },
    importsFromStatements: (params) => {
        const { parsedSource, inProjectPath } = params;
        return parsedSource.statements
            .map((statement) => _self.importsFromStatement({ statement, inProjectPath }))
            .filter(Boolean)
            .flat();
    },
    importsFromStatement: (params) => {
        const { statement, inProjectPath } = params;
        if (statement.kind != ts_1.default.SyntaxKind.ImportDeclaration)
            return [];
        return new ts_parser_import_1.TsParserImport({ statement, inProjectPath }).parse();
    },
    entityLinksFromStatements: (params) => {
        const { parsedSource, inProjectPath } = params;
        return parsedSource.statements
            .map((statement) => _self.entityLinksFromStatement({ statement, inProjectPath }))
            .filter(Boolean)
            .flat();
    },
    entityLinksFromStatement: (params) => {
        const { statement, inProjectPath } = params;
        if (!_self._isViableExportableStatementKind(statement.kind))
            return [];
        // TODO find a better solution to finding entity links
        if (statement['name'])
            return [{ name: statement['name'].escapedText, inProjectPath }];
        if (statement['declarationList'])
            return [{ name: statement['declarationList'].declarations[0].name.escapedText, inProjectPath }];
        return [];
    },
};
exports.tsParserService = _self;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHMtcGFyc2VyLXNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZS9jb252ZXJ0LXRzL3RzLXBhcnNlci1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9GQUE2RTtBQUM3RSw0REFBdUQ7QUFDdkQsdURBQThCO0FBQzlCLHFGQUEwRztBQUMxRywyREFBdUQ7QUFDdkQsNENBQXdDO0FBRXhDLE1BQU0sS0FBSyxHQUFHO0lBQ1osVUFBVSxFQUFFLENBQUMsU0FBNkIsRUFBVyxFQUFFO1FBQ3JELElBQUksQ0FBQyxTQUFTO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFDNUIsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFFLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBQ3hFLENBQUM7SUFDRCxVQUFVLEVBQUUsQ0FBQyxTQUE2QixFQUFXLEVBQUU7UUFDckQsSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLEtBQUssQ0FBQTtRQUM1QixPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLFlBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUE7SUFDMUUsQ0FBQztJQUNELFdBQVcsRUFBRSxDQUFDLFNBQTZCLEVBQTJCLEVBQUU7UUFDdEUsSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLG9EQUF1QixDQUFDLFdBQVcsQ0FBQTtRQUMxRCxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssWUFBRSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUM7WUFBRSxPQUFPLG9EQUF1QixDQUFDLE1BQU0sQ0FBQTtR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QyxNQUE4RCxFQUErQixFQUFFO1FBQ3pILE1BQU0sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQzlDLE9BQU8sWUFBWSxDQUFDLFVBQVU7YUFDM0IsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQzthQUNoRixNQUFNLENBQUMsT0FBTyxDQUFDO2FBQ2YsSUFBSSxFQUFFLENBQUE7SUFDWCxDQUFDO0lBQ0Qsd0JBQXdCLEVBQUUsQ0FBQyxNQUEwRCxFQUErQixFQUFFO1FBQ3BILE1BQU0sRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztZQUFFLE9BQU8sRUFBRSxDQUFBO1FBRXRFLHNEQUFzRDtRQUN0RCxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUM7WUFBRSxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLElBQUksU0FBUyxDQUFDLGlCQUFpQixDQUFDO1lBQzlCLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO1FBRWpHLE9BQU8sRUFBRSxDQUFBO0lBQ1gsQ0FBQztDQUNGLENBQUE7QUFFWSxRQUFBLGVBQWUsR0FBRyxLQUFLLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZSB9IGZyb20gJ3NyYy9lbnVtL3Byb3BlcnR5LWFjY2Vzcy1sZXZlbC10eXBlJ1xuaW1wb3J0IHsgUmVmZXJlbmNlVHlwZSB9IGZyb20gJ3NyYy9lbnVtL3JlZmVyZW5jZS10eXBlJ1xuaW1wb3J0IHRzIGZyb20gJ3NyYy9tb2R1bGUvdHMnXG5pbXBvcnQgeyBUc1BhcnNlckltcG9ydCwgVHNQYXJzZXJJbXBvcnRQYXJzZVJlc3VsdCB9IGZyb20gJ3NyYy9zZXJ2aWNlL2NvbnZlcnQtdHMvcGFyc2VyL3RzLXBhcnNlci1pbXBvcnQnXG5pbXBvcnQgeyBSZWZlcmVuY2UgfSBmcm9tICdzcmMvc2VydmljZS9tb2RlbC9yZWZlcmVuY2UnXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdzcmMvdXRpbC9sb2dnZXInXG5cbmNvbnN0IF9zZWxmID0ge1xuICBpc0V4cG9ydGVkOiAobW9kaWZpZXJzPzogdHMuTW9kaWZpZXJzQXJyYXkpOiBib29sZWFuID0+IHtcbiAgICBpZiAoIW1vZGlmaWVycykgcmV0dXJuIGZhbHNlXG4gICAgcmV0dXJuICEhbW9kaWZpZXJzLmZpbmQoKG0pID0+IG0ua2luZCA9PT0gdHMuU3ludGF4S2luZC5FeHBvcnRLZXl3b3JkKVxuICB9LFxuICBpc0Fic3RyYWN0OiAobW9kaWZpZXJzPzogdHMuTW9kaWZpZXJzQXJyYXkpOiBib29sZWFuID0+IHtcbiAgICBpZiAoIW1vZGlmaWVycykgcmV0dXJuIGZhbHNlXG4gICAgcmV0dXJuICEhbW9kaWZpZXJzLmZpbmQoKG0pID0+IG0ua2luZCA9PT0gdHMuU3ludGF4S2luZC5BYnN0cmFjdEtleXdvcmQpXG4gIH0sXG4gIGFjY2Vzc0xldmVsOiAobW9kaWZpZXJzPzogdHMuTW9kaWZpZXJzQXJyYXkpOiBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZSA9PiB7XG4gICAgaWYgKCFtb2RpZmllcnMpIHJldHVybiBQcm9wZXJ0eUFjY2Vzc0xldmVsVHlwZS5OT19NT0RJRklFUlxuICAgIGlmIChtb2RpZmllcnMuZmluZCgobSkgPT4gbS5raW5kID09PSB0cy5TeW50YXhLaW5kLlB1YmxpY0tleXdvcmQpKSByZXR1cm4gUHJvcGVydHlBY2Nlc3NMZXZlbFR5cGUuUFVCTElDXG4gICAgaWYgKG1vZGlmaWVycy5maW5kKChtKSA9PiBtLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuUHJpdmF0ZUtleXdvcmQpKSByZXR1cm4gUHJvcGVydHlBY2Nlc3NMZXZlbFR5cGUuUFJJVkFURVxuICAgIGlmIChtb2RpZmllcnMuZmluZCgobSkgPT4gbS5raW5kID09PSB0cy5TeW50YXhLaW5kLlByb3RlY3RlZEtleXdvcmQpKSByZXR1cm4gUHJvcGVydHlBY2Nlc3NMZXZlbFR5cGUuUFJPVEVDVEVEXG4gICAgcmV0dXJuIFByb3BlcnR5QWNjZXNzTGV2ZWxUeXBlLk5PX01PRElGSUVSXG4gIH0sXG4gIGNoZWNrSWZUaGVyZUFyZUFueUV4cG9ydHM6IChwYXJzZWRTb3VyY2U6IHRzLlNvdXJjZUZpbGUpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gISFwYXJzZWRTb3VyY2Uuc3RhdGVtZW50cy5maW5kKChzKSA9PiBfc2VsZi5faXNWaWFibGVFeHBvcnRhYmxlU3RhdGVtZW50S2luZChzLmtpbmQpICYmIF9zZWxmLmlzRXhwb3J0ZWQocy5tb2RpZmllcnMpKVxuICB9LFxuICBfaXNWaWFibGVFeHBvcnRhYmxlU3RhdGVtZW50S2luZDogKGtpbmQ6IG51bWJlcik6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiBbXG4gICAgICB0cy5TeW50YXhLaW5kLlR5cGVBbGlhc0RlY2xhcmF0aW9uLFxuICAgICAgdHMuU3ludGF4S2luZC5DbGFzc0RlY2xhcmF0aW9uLFxuICAgICAgdHMuU3ludGF4S2luZC5JbnRlcmZhY2VEZWNsYXJhdGlvbixcbiAgICAgIHRzLlN5bnRheEtpbmQuVmFyaWFibGVEZWNsYXJhdGlvbixcbiAgICAgIHRzLlN5bnRheEtpbmQuVmFyaWFibGVTdGF0ZW1lbnQsXG4gICAgICB0cy5TeW50YXhLaW5kLlZhcmlhYmxlRGVjbGFyYXRpb25MaXN0LFxuICAgICAgdHMuU3ludGF4S2luZC5FbnVtRGVjbGFyYXRpb24sXG4gICAgXS5pbmNsdWRlcyhraW5kKVxuICB9LFxuICBmaW5kQ2xhc3NSZWxhdGlvbnM6IChwYXJhbXM6IHsgc3RhdGVtZW50OiB0cy5TdGF0ZW1lbnQ7IHBhcnNlZFNvdXJjZTogdHMuU291cmNlRmlsZTsgaW5Qcm9qZWN0UGF0aDogc3RyaW5nIH0pOiBSZWZlcmVuY2VbXSA9PiB7XG4gICAgY29uc3QgeyBzdGF0ZW1lbnQsIHBhcnNlZFNvdXJjZSwgaW5Qcm9qZWN0UGF0aCB9ID0gcGFyYW1zXG4gICAgY29uc3QgZXh0ZW5kSW1wbGVtZW50cyA9IChzdGF0ZW1lbnRbJ2hlcml0YWdlQ2xhdXNlcyddID8/IFtdKVxuICAgICAgLm1hcCgoaGVyaXRhZ2UpID0+IHtcbiAgICAgICAgY29uc3QgdHlwZSA9IGhlcml0YWdlLmdldFRleHQocGFyc2VkU291cmNlKS5zcGxpdCgnICcpWzBdXG4gICAgICAgIHJldHVybiAoaGVyaXRhZ2UudHlwZXMgPz8gW10pLm1hcCgodCkgPT4gKHsgdHlwZSwgbmFtZTogdC5leHByZXNzaW9uLmVzY2FwZWRUZXh0IH0pKVxuICAgICAgfSlcbiAgICAgIC5mbGF0KCkgYXMgeyB0eXBlOiAnaW1wbGVtZW50cycgfCAnZXh0ZW5kcyc7IG5hbWU6IHN0cmluZyB9W11cbiAgICBpZiAoZXh0ZW5kSW1wbGVtZW50cy5sZW5ndGggPT09IDApIHJldHVybiBbXVxuXG4gICAgY29uc3QgZmlsZUltcG9ydHMgPSBwYXJzZWRTb3VyY2Uuc3RhdGVtZW50c1xuICAgICAgLm1hcCgoc3RhdGVtZW50KSA9PiBuZXcgVHNQYXJzZXJJbXBvcnQoeyBzdGF0ZW1lbnQsIGluUHJvamVjdFBhdGggfSkucGFyc2UoKSlcbiAgICAgIC5mbGF0KClcblxuICAgIHJldHVybiBleHRlbmRJbXBsZW1lbnRzXG4gICAgICAubWFwKChlaSkgPT4ge1xuICAgICAgICBjb25zdCBmaWxlSW1wb3J0ID0gZmlsZUltcG9ydHMuZmluZCgoZmkpID0+IHtcbiAgICAgICAgICByZXR1cm4gZmkubmFtZSA9PT0gZWkubmFtZVxuICAgICAgICB9KVxuICAgICAgICBpZiAoIWZpbGVJbXBvcnQpIHtcbiAgICAgICAgICBsb2dnZXIud2FybihgSW1wb3J0IG5vdCBmb3VuZCBmb3IgJHtKU09OLnN0cmluZ2lmeShlaSl9YClcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFJlZmVyZW5jZSh7XG4gICAgICAgICAgbmFtZTogZWkubmFtZSxcbiAgICAgICAgICB0eXBlOiBlaS50eXBlID09PSAnaW1wbGVtZW50cycgPyBSZWZlcmVuY2VUeXBlLklNUExFTUVOVEFUSU9OIDogUmVmZXJlbmNlVHlwZS5JTkhFUklUQU5DRSxcbiAgICAgICAgICBpblByb2plY3RQYXRoOiBmaWxlSW1wb3J0LmluUHJvamVjdFBhdGgsXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgICAgLmZpbHRlcihCb29sZWFuKSBhcyBSZWZlcmVuY2VbXVxuICB9LFxuICBpbXBvcnRzRnJvbVN0YXRlbWVudHM6IChwYXJhbXM6IHsgcGFyc2VkU291cmNlOiB0cy5Tb3VyY2VGaWxlOyBpblByb2plY3RQYXRoOiBzdHJpbmcgfSk6IFRzUGFyc2VySW1wb3J0UGFyc2VSZXN1bHRbXSA9PiB7XG4gICAgY29uc3QgeyBwYXJzZWRTb3VyY2UsIGluUHJvamVjdFBhdGggfSA9IHBhcmFtc1xuICAgIHJldHVybiBwYXJzZWRTb3VyY2Uuc3RhdGVtZW50c1xuICAgICAgLm1hcCgoc3RhdGVtZW50KSA9PiBfc2VsZi5pbXBvcnRzRnJvbVN0YXRlbWVudCh7IHN0YXRlbWVudCwgaW5Qcm9qZWN0UGF0aCB9KSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgIC5mbGF0KClcbiAgfSxcbiAgaW1wb3J0c0Zyb21TdGF0ZW1lbnQ6IChwYXJhbXM6IHsgc3RhdGVtZW50OiB0cy5TdGF0ZW1lbnQ7IGluUHJvamVjdFBhdGg6IHN0cmluZyB9KTogVHNQYXJzZXJJbXBvcnRQYXJzZVJlc3VsdFtdID0+IHtcbiAgICBjb25zdCB7IHN0YXRlbWVudCwgaW5Qcm9qZWN0UGF0aCB9ID0gcGFyYW1zXG4gICAgaWYgKHN0YXRlbWVudC5raW5kICE9IHRzLlN5bnRheEtpbmQuSW1wb3J0RGVjbGFyYXRpb24pIHJldHVybiBbXVxuICAgIHJldHVybiBuZXcgVHNQYXJzZXJJbXBvcnQoeyBzdGF0ZW1lbnQsIGluUHJvamVjdFBhdGggfSkucGFyc2UoKVxuICB9LFxuICBlbnRpdHlMaW5rc0Zyb21TdGF0ZW1lbnRzOiAocGFyYW1zOiB7IHBhcnNlZFNvdXJjZTogdHMuU291cmNlRmlsZTsgaW5Qcm9qZWN0UGF0aDogc3RyaW5nIH0pOiBUc1BhcnNlckltcG9ydFBhcnNlUmVzdWx0W10gPT4ge1xuICAgIGNvbnN0IHsgcGFyc2VkU291cmNlLCBpblByb2plY3RQYXRoIH0gPSBwYXJhbXNcbiAgICByZXR1cm4gcGFyc2VkU291cmNlLnN0YXRlbWVudHNcbiAgICAgIC5tYXAoKHN0YXRlbWVudCkgPT4gX3NlbGYuZW50aXR5TGlua3NGcm9tU3RhdGVtZW50KHsgc3RhdGVtZW50LCBpblByb2plY3RQYXRoIH0pKVxuICAgICAgLmZpbHRlcihCb29sZWFuKVxuICAgICAgLmZsYXQoKVxuICB9LFxuICBlbnRpdHlMaW5rc0Zyb21TdGF0ZW1lbnQ6IChwYXJhbXM6IHsgc3RhdGVtZW50OiB0cy5TdGF0ZW1lbnQ7IGluUHJvamVjdFBhdGg6IHN0cmluZyB9KTogVHNQYXJzZXJJbXBvcnRQYXJzZVJlc3VsdFtdID0+IHtcbiAgICBjb25zdCB7IHN0YXRlbWVudCwgaW5Qcm9qZWN0UGF0aCB9ID0gcGFyYW1zXG4gICAgaWYgKCFfc2VsZi5faXNWaWFibGVFeHBvcnRhYmxlU3RhdGVtZW50S2luZChzdGF0ZW1lbnQua2luZCkpIHJldHVybiBbXVxuXG4gICAgLy8gVE9ETyBmaW5kIGEgYmV0dGVyIHNvbHV0aW9uIHRvIGZpbmRpbmcgZW50aXR5IGxpbmtzXG4gICAgaWYgKHN0YXRlbWVudFsnbmFtZSddKSByZXR1cm4gW3sgbmFtZTogc3RhdGVtZW50WyduYW1lJ10uZXNjYXBlZFRleHQsIGluUHJvamVjdFBhdGggfV1cbiAgICBpZiAoc3RhdGVtZW50WydkZWNsYXJhdGlvbkxpc3QnXSlcbiAgICAgIHJldHVybiBbeyBuYW1lOiBzdGF0ZW1lbnRbJ2RlY2xhcmF0aW9uTGlzdCddLmRlY2xhcmF0aW9uc1swXS5uYW1lLmVzY2FwZWRUZXh0LCBpblByb2plY3RQYXRoIH1dXG5cbiAgICByZXR1cm4gW11cbiAgfSxcbn1cblxuZXhwb3J0IGNvbnN0IHRzUGFyc2VyU2VydmljZSA9IF9zZWxmXG4iXX0=